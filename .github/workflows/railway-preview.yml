name: Railway Preview Deploy

on:
  workflow_run:
    workflows: ['CI']
    types: [completed]

env:
  NODE_VERSION: '20'

jobs:
  deploy-preview:
    # Only run if CI succeeded and it's a PR
    if: github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      statuses: write
    outputs:
      preview_url: ${{ steps.deploy.outputs.preview_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Deploy to Railway
        id: deploy
        working-directory: ${{ github.workspace }}
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          set -euo pipefail

          retry_cmd() {
            local n=0 max=5 delay=5
            until "$@"; do
              n=$((n+1))
              if [ "$n" -ge "$max" ]; then return 1; fi
              sleep "$delay"
              delay=$((delay*2))
            done
          }

          retry_out() {
            local n=0 max=5 delay=5 out
            while true; do
              if out="$($@)"; then echo "$out"; return 0; fi
              n=$((n+1))
              if [ "$n" -ge "$max" ]; then return 1; fi
              sleep "$delay"
              delay=$((delay*2))
            done
          }

          ENV_NAME="pr-${{ github.event.workflow_run.id }}"
          echo "environment=$ENV_NAME" >> "$GITHUB_OUTPUT"

          retry_cmd railway link --service codecollabproj2
          retry_cmd railway up --environment "$ENV_NAME" --detached

          PREVIEW_DOMAIN=$(retry_out railway domain --json --environment "$ENV_NAME" | jq -r '.[0].domain // empty')
          [ -z "$PREVIEW_DOMAIN" ] && { echo "Failed to get domain"; exit 1; }

          PREVIEW_URL="https://$PREVIEW_DOMAIN"
          retry_cmd curl -fsS --max-time 10 "$PREVIEW_URL" > /dev/null

          echo "preview_url=$PREVIEW_URL" >> "$GITHUB_OUTPUT"
          echo "Deployed: $PREVIEW_URL"

      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸš€ **Preview Deployed**\nURL: ${{ steps.deploy.outputs.preview_url }}`
            });

  test-preview:
    needs: deploy-preview
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Install Playwright
        run: npx playwright install --with-deps chromium

      - name: Run E2E Tests
        run: npx playwright test
        env:
          BASE_URL: ${{ needs.deploy-preview.outputs.preview_url }}
          CI: true

      - name: Upload Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7
